# 転送・スレッド管理仕様 (Threading & Forwarding)

## 1. 概要
受信用ドメイン (`rikut0904.site`) と送信用ドメイン (`ml.rikut0904.site`) が異なるため、独自の管理コード（UUID）を用いて会話の継続性を担保する。

## 2. スレッド紐付けロジック
- **管理コードの抽出**: 
    - 受信メールの本文から正規表現 `【管理コード: ([^】]+)】` を用いてコードを検索。
- **DB照会**: 
    - 抽出したコードが `sent_mails` テーブルの `management_code` と一致するか確認。
- **スレッドグループ化**: 
    - 一致した場合、その受信メールを既存の `thread_groups` に紐付ける。
    - 一致しない、またはコードがない場合は、新規のスレッドとして扱う。

## 3. 送信・転送時の挙動
- **新規作成 (New)**: 
    - 新しい `parent_uuid` を発行し、本文末尾に署名として挿入。
- **スレッドへの返信 (Reply)**: 
    - そのスレッドに紐付いている最新の `management_code` を自動で引用し、本文に挿入。
- **転送 (Forward)**:
    - **1:1の場合**: 元のメールのUUIDを継承して本文に挿入。
    - **1:Nの場合**: 親スレッドIDを維持しつつ、転送先ごとに新しい「子UUID」を発行して本文に挿入。

## 4. UI表示仕様
- **タイムライン表示**: 
    - 同一の `thread_group` に属するメールを、送信・受信問わず時系列で並べて表示。
- **返信誘導**: 
    - 送信メールの署名に `mailto:` リンクを生成し、クリック時に件名や本文へ自動で管理コードが入力されるよう支援する。
